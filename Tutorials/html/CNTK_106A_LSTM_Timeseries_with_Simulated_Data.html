

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CNTK 106: Part A - Time series prediction with LSTM (Basics) &mdash; CNTK Tutorial Documentation  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="CNTK Tutorial Documentation  documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="tutindex.html" class="icon icon-home"> CNTK Tutorial Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">CNTK 106: Part A - Time series prediction with LSTM (Basics)</a><ul>
<li><a class="reference internal" href="#Data-generation">Data generation</a></li>
<li><a class="reference internal" href="#Network-modeling">Network modeling</a></li>
<li><a class="reference internal" href="#Training-the-network">Training the network</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="tutindex.html">CNTK Tutorial Documentation</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="tutindex.html">Docs</a> &raquo;</li>
        
      <li>CNTK 106: Part A - Time series prediction with LSTM (Basics)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/CNTK_106A_LSTM_Timeseries_with_Simulated_Data.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
<div class="section" id="CNTK-106:-Part-A---Time-series-prediction-with-LSTM-(Basics)">
<h1>CNTK 106: Part A - Time series prediction with LSTM (Basics)<a class="headerlink" href="#CNTK-106:-Part-A---Time-series-prediction-with-LSTM-(Basics)" title="Permalink to this headline">¶</a></h1>
<p>This tutorial demonstrates how to use CNTK to predict future values in a
time series using LSTMs.</p>
<p><strong>Goal</strong></p>
<p>We use simulated data set of a continuous function (in our case a <a class="reference external" href="https://en.wikipedia.org/wiki/Sine">sine
wave</a>). From <code class="docutils literal"><span class="pre">N</span></code> previous
values of the <span class="math">\(y = sin(t)\)</span> function where <span class="math">\(y\)</span> is the
observed amplitude signal at time <span class="math">\(t\)</span>, we will predict <code class="docutils literal"><span class="pre">M</span></code>
values of <span class="math">\(y\)</span> for the corresponding future time points.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Figure 1</span>
<span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;http://www.cntk.ai/jup/sinewave.jpg&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<img src="http://www.cntk.ai/jup/sinewave.jpg"/></div>
</div>
<p>In this tutorial we will use
<a class="reference external" href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTM</a> to
implement our model. LSTMs are well suited for this task because their
ability to learn from experience. For details on how LSTMs work, see
<a class="reference external" href="http://colah.github.io/posts/2015-08-Understanding-LSTMs">this excellent
post</a>.</p>
<p>In this tutorial we will have following sub-sections: - Simulated data
generation - LSTM network modeling - Model training and evaluation</p>
<p>This model works for lots real world data. In part A of this tutorial we
use a simple sin(x) function and in part B of the tutorial (currently in
development) we will use real data from IOT device and try to predict
daily output of solar panel.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">cntk</span> <span class="kn">as</span> <span class="nn">C</span>
<span class="kn">import</span> <span class="nn">cntk.tests.test_utils</span>
<span class="n">cntk</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">test_utils</span><span class="o">.</span><span class="n">set_device_from_pytest_env</span><span class="p">()</span> <span class="c1"># (only needed for our build system)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<p>There are two run modes: - <em>Fast mode</em>: <code class="docutils literal"><span class="pre">isFast</span></code> is set to <code class="docutils literal"><span class="pre">True</span></code>.
This is the default mode for the notebooks, which means we train for
fewer iterations or train / test on limited data. This ensures
functional correctness of the notebook though the models produced are
far from what a completed training would produce.</p>
<ul class="simple">
<li><em>Slow mode</em>: We recommend the user to set this flag to <code class="docutils literal"><span class="pre">False</span></code> once
the user has gained familiarity with the notebook content and wants
to gain insight from running the notebooks for a longer period with
different parameters for training.</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">isFast</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="Data-generation">
<h2>Data generation<a class="headerlink" href="#Data-generation" title="Permalink to this headline">¶</a></h2>
<p>We need a few helper methods to generate the simulated sine wave data.
Let <code class="docutils literal"><span class="pre">N</span></code> and <code class="docutils literal"><span class="pre">M</span></code> be a ordered set of past values and future (desired
predicted values) of the sine wave, respectively.</p>
<ul>
<li><p class="first"><strong>``generate_data()``</strong></p>
<blockquote>
<div><p>In this tutorial, we sample <code class="docutils literal"><span class="pre">N</span></code> consecutive values of the <code class="docutils literal"><span class="pre">sin</span></code>
function as the input to the model and try to predict future values
that is <code class="docutils literal"><span class="pre">M</span></code> steps away from the last observed value in the input
model. We generate multiple such instances of the input signal (by
sampling from <code class="docutils literal"><span class="pre">sin</span></code> function) each of size <code class="docutils literal"><span class="pre">N</span></code> and the
corresponding desired output as our training data. Assuming
<span class="math">\(k\)</span> = batch size, <code class="docutils literal"><span class="pre">generate_data</span></code> function produces the
<span class="math">\(X\)</span> and corresponding <span class="math">\(L\)</span> data and returns numpy arrays
of the following shape:</p>
<p>The input set (<span class="math">\(X\)</span>) to the lstm:</p>
<div class="math">
\[ X = [\{y_{11}, y_{12},  \cdots , y_{1N}\},
\{y_{21}, y_{22}, \cdots, y_{2N}\}, \cdots,
\{y_{k1}, y_{k2}, \cdots, y_{kN}\}]\]</div>
<p>In the above samples <span class="math">\(y_{i,j}\)</span>, represents the observed
function value for the <span class="math">\(i^{th}\)</span> batch and <span class="math">\(j^{th}\)</span> time
point within the time window of <span class="math">\(N\)</span> points.</p>
<p>The desired output (<span class="math">\(L\)</span>) with <code class="docutils literal"><span class="pre">M</span></code> steps in the future:</p>
<div class="math">
\[ L = [ \{y_{1,N+M}\},
\{y_{2,N+M}\}, \cdots, \{y_{k,N+M}\}]\]</div>
<p>Note: <code class="docutils literal"><span class="pre">k</span></code> is a function of the length of the time series and the
number of windows of size <code class="docutils literal"><span class="pre">N</span></code> one can have for the time series.</p>
</div></blockquote>
</li>
<li><p class="first"><strong>``split_data()``</strong></p>
<blockquote>
<div><p>As the name suggests, <code class="docutils literal"><span class="pre">split_data</span></code> function will split the data
into training, validation and test sets.</p>
</div></blockquote>
</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    splits np.array into training, validation and test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pos_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">test_size</span><span class="p">))</span>
    <span class="n">pos_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">pos_test</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">val_size</span><span class="p">))</span>

    <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">pos_val</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">pos_val</span><span class="p">:</span><span class="n">pos_test</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">pos_test</span><span class="p">:]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">test</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">generate_data</span><span class="p">(</span><span class="n">fct</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">time_steps</span><span class="p">,</span> <span class="n">time_shift</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generate sequences to feed to rnn for fct(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fct</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_shift</span><span class="p">],</span>
                                 <span class="n">b</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">time_shift</span><span class="p">:]))</span>
    <span class="n">rnn_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">time_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">rnn_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">time_steps</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
    <span class="n">rnn_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rnn_x</span><span class="p">)</span>

    <span class="c1"># Reshape or rearrange the data from row to columns</span>
    <span class="c1"># to be compatible with the input needed by the LSTM model</span>
    <span class="c1"># which expects 1 float per time point in a given batch</span>
    <span class="n">rnn_x</span> <span class="o">=</span> <span class="n">rnn_x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rnn_x</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

    <span class="n">rnn_y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">rnn_y</span> <span class="o">=</span> <span class="n">rnn_y</span><span class="p">[</span><span class="n">time_steps</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">:]</span>

    <span class="c1"># Reshape or rearrange the data from row to columns</span>
    <span class="c1"># to match the input shape</span>
    <span class="n">rnn_y</span> <span class="o">=</span> <span class="n">rnn_y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rnn_y</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

    <span class="k">return</span> <span class="n">split_data</span><span class="p">(</span><span class="n">rnn_x</span><span class="p">),</span> <span class="n">split_data</span><span class="p">(</span><span class="n">rnn_y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let us generate and visualize the generated data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># input: N subsequent values</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># output: predict 1 value M steps ahead</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">generate_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>

<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]):</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">ds</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">ds</span> <span class="o">+</span> <span class="s1">&#39; raw&#39;</span><span class="p">);</span>
<span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">];</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_11_0.png" src="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_11_0.png" />
</div>
</div>
</div>
<div class="section" id="Network-modeling">
<h2>Network modeling<a class="headerlink" href="#Network-modeling" title="Permalink to this headline">¶</a></h2>
<p>We setup our network with 1 LSTM cell for each input. We have N inputs
and each input is a value in our continuous function. The N outputs from
the LSTM are the input into a dense layer that produces a single output.
Between LSTM and dense layer we insert a dropout layer that randomly
drops 20% of the values coming the LSTM to prevent overfitting the model
to the training dataset. We want use use the dropout layer during
training but when using the model to make predictions we don’t want to
drop values. <img alt="lstm" src="https://www.cntk.ai/jup/cntk106A_model_s3.png" /></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create the model for time series prediction&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">default_options</span><span class="p">(</span><span class="n">initial_state</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Recurrence</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">N</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">)(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Training-the-network">
<h2>Training the network<a class="headerlink" href="#Training-the-network" title="Permalink to this headline">¶</a></h2>
<p>We define the <code class="docutils literal"><span class="pre">next_batch()</span></code> iterator that produces batches we can
feed to the training function. Note that because CNTK supports variable
sequence length, we must feed the batches as list of sequences. This is
a convenience function to generate small batches of data often referred
to as minibatch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">next_batch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get the next batch to process&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">as_batch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="n">part</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">count</span><span class="p">):</span>
            <span class="n">part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ds</span><span class="p">])</span><span class="o">-</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">as_batch</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ds</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">),</span> <span class="n">as_batch</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">ds</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Setup everything else we need for training the model: define user
specified training parameters, define inputs, outputs, model and the
optimizer.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Training parameters</span>

<span class="n">TRAINING_STEPS</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">isFast</span> <span class="k">else</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<p><strong>Key Insight</strong></p>
<p>There are some key learnings when <a class="reference external" href="https://www.cntk.ai/pythondocs/sequence.html">working with
sequences</a> in LSTM
networks. A brief recap:</p>
<p>CNTK inputs, outputs and parameters are organized as tensors. Each
tensor has a rank: A scalar is a tensor of rank 0, a vector is a tensor
of rank 1, a matrix is a tensor of rank 2, and so on. We refer to these
different dimensions as axes.</p>
<p>Every CNTK tensor has some static axes and some dynamic axes. The static
axes have the same length throughout the life of the network. The
dynamic axes are like static axes in that they define a meaningful
grouping of the numbers contained in the tensor but: - their length can
vary from instance to instance, - their length is typically not known
before each minibatch is presented, and - they may be ordered.</p>
<p>In CNTK the axis over which you run a recurrence is dynamic and thus its
dimensions are unknown at the time you define your variable. Thus the
input variable only lists the shapes of the static axes. Since our
inputs are a sequence of one dimensional numbers we specify the input as</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">C.sequence.input_variable(1)</span></code></div></blockquote>
<p>The <code class="docutils literal"><span class="pre">N</span></code> instances of the observed <code class="docutils literal"><span class="pre">sin</span></code> function output and the
corresponding batch are implicitly represented in the dynamic axis as
shown below in the form of defaults.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">C</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">default_batch_axis</span><span class="p">(),</span> <span class="n">C</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">default_dynamic_axis</span><span class="p">()]</span>
<span class="n">C</span><span class="o">.</span><span class="n">input_variable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">x_axes</span><span class="p">)</span>
</pre></div>
</div>
<p>The reader should be aware of the meaning of the default parameters.
Specifiying the dynamic axes enables the recurrence engine handle
the time sequence data in the expected order. Please take time to
understand how to work with both static and dynamic axes in CNTK as
described <a class="reference external" href="https://www.cntk.ai/pythondocs/sequence.html">here</a>.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># input sequences</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">sequence</span><span class="o">.</span><span class="n">input_variable</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># create the model</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">create_model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># expected output (label), also the dynamic axes of the model output</span>
<span class="c1"># is specified as the model of the label input</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">input_variable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dynamic_axes</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">dynamic_axes</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>

<span class="c1"># the learning rate</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">lr_schedule</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">learning_rate_schedule</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">UnitType</span><span class="o">.</span><span class="n">minibatch</span><span class="p">)</span>

<span class="c1"># loss function</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">squared_error</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

<span class="c1"># use squared error to determine error for now</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">squared_error</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>

<span class="c1"># use fsadagrad optimizer</span>
<span class="n">momentum_time_constant</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">momentum_as_time_constant_schedule</span><span class="p">(</span><span class="n">BATCH_SIZE</span> <span class="o">/</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
<span class="n">learner</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">fsadagrad</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
                      <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_schedule</span><span class="p">,</span>
                      <span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum_time_constant</span><span class="p">,</span>
                      <span class="n">unit_gain</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">error</span><span class="p">),</span> <span class="p">[</span><span class="n">learner</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>We are ready to train. 100 epochs should yield acceptable results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># train</span>
<span class="n">loss_summary</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">next_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">):</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train_minibatch</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span> <span class="n">l</span><span class="p">:</span> <span class="n">y1</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="p">(</span><span class="n">EPOCHS</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">training_loss</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">previous_minibatch_loss_average</span>
        <span class="n">loss_summary</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training_loss</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;epoch: {}, loss: {:.5f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">training_loss</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;training took {0:.1f} sec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
epoch: 0, loss: 0.23901
epoch: 2, loss: 0.20915
epoch: 4, loss: 0.17376
epoch: 6, loss: 0.16345
epoch: 8, loss: 0.12779
epoch: 10, loss: 0.08072
epoch: 12, loss: 0.07176
epoch: 14, loss: 0.08464
epoch: 16, loss: 0.10477
epoch: 18, loss: 0.07393
training took 12.1 sec
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># A look how the loss function shows how well the model is converging</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss_summary</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training loss&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_23_0.png" src="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_23_0.png" />
</div>
</div>
<p>Normally we would validate the training on the data that we set aside
for validation but since the input data is small we can run validattion
on all parts of the dataset.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># validate</span>
<span class="k">def</span> <span class="nf">get_mse</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">labeltxt</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">next_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">labeltxt</span><span class="p">):</span>
        <span class="n">eval_error</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">test_minibatch</span><span class="p">({</span><span class="n">x</span> <span class="p">:</span> <span class="n">x1</span><span class="p">,</span> <span class="n">l</span> <span class="p">:</span> <span class="n">y1</span><span class="p">})</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">eval_error</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">labeltxt</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Print the train and validation errors</span>
<span class="k">for</span> <span class="n">labeltxt</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">]:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;mse for {}: {:.6f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labeltxt</span><span class="p">,</span> <span class="n">get_mse</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">labeltxt</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mse for train: 0.000115
mse for val: 0.000097
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Print validate and test error</span>
<span class="n">labeltxt</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;mse for {}: {:.6f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labeltxt</span><span class="p">,</span> <span class="n">get_mse</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">labeltxt</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
mse for test: 0.000103
</pre></div></div>
</div>
<p>Since we used a simple sin(x) function we should expect that the errors
are the same for train, validation and test sets. For real datasets that
will be different of course. We also plot the expected output (Y) and
the prediction our model made to shows how well the simple LSTM approach
worked.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># predict</span>
<span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="ow">in</span> <span class="n">next_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">x1</span><span class="p">})</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">ds</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">+</span> <span class="s1">&#39; raw&#39;</span><span class="p">);</span>
    <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">+</span> <span class="s1">&#39; predicted&#39;</span><span class="p">);</span>
<span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">];</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_29_0.png" src="_images/CNTK_106A_LSTM_Timeseries_with_Simulated_Data_29_0.png" />
</div>
</div>
<p>Not perfect but close enough, considering the simplicity of the model.</p>
<p>Here we used a simple sin wave but you can tinker yourself and try other
time series data. <code class="docutils literal"><span class="pre">generate_data()</span></code> allows you to pass in a dataframe
with ‘a’ and ‘b’ columns instead of a function.</p>
<p>To improve results, we could train with more data points, let the model
train for more epochs, or improve the model itself.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Cognitive Toolkit (CNTK) Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>